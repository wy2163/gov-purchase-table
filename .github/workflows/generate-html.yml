# 工作流名称（显示在Actions面板）
name: 自动生成政府采购HTML表格并部署

# 触发条件：main分支推送指定文件 / 手动触发
on:
  push:
    branches: [ main ]
    paths: [ '采购公告.csv', '采购意向公告.csv', 'generate_html.py' ] # 仅这3个文件更新时触发
  workflow_dispatch: # 允许手动触发（Actions面板可点击运行）

# 执行的任务
jobs:
  build-and-deploy:
    # 运行环境：Ubuntu最新版
    runs-on: ubuntu-latest
    # 任务步骤
    steps:
      # 步骤1：拉取仓库代码到运行环境
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          persist-credentials: false # 关闭默认token持久化（避免权限冲突）
          fetch-depth: 0 # 拉取完整提交历史（可选，确保文件完整）
        
      # 步骤2：配置Python 3.9环境
      - name: 设置Python运行环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip' # 缓存pip依赖（加速后续运行）
          
      # 步骤3：安装Python依赖（pandas等）
      - name: 安装依赖包
        run: |
          python -m pip install --upgrade pip
          pip install pandas
          
      # 步骤4：运行脚本生成HTML文件
      - name: 执行脚本生成政府采购表格HTML
        run: python generate_html.py
        # 可选：捕获脚本输出，方便排查错误
        continue-on-error: false # 脚本运行失败则终止工作流
      
      # 步骤5：将生成的HTML推送到gh-pages分支
      - name: 部署到gh-pages分支
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.GH_PAT }} # 仓库秘钥中的PAT（需提前配置）
          publish_dir: ./ # HTML文件所在目录（根目录）
          publish_branch: gh-pages # 目标分支
          user_name: 'github-actions[bot]' # 提交者名称
          user_email: 'github-actions[bot]@users.noreply.github.com' # 提交者邮箱
          commit_message: 'Auto generate gov purchase HTML table: ${{ github.event.head_commit.message }}' # 提交备注（带原提交信息）
